<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>L√¨ X√¨ Arcade</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: radial-gradient(1200px 600px at 20% 0%, rgba(43,127,255,.20), transparent 60%), radial-gradient(900px 500px at 80% 20%, rgba(255,80,80,.18), transparent 60%), #070a10; color: #e8eef6; }
    .wrap { max-width: 1120px; margin: 0 auto; padding: 18px; display: grid; gap: 14px; }
    .card { background: rgba(14,20,32,.74); border: 1px solid rgba(70,100,160,.38); border-radius: 18px; padding: 16px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0; font-size: 20px; letter-spacing: .2px; }
    h2 { margin: 0 0 10px; font-size: 16px; opacity: .98; }
    .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding: 7px 12px; border-radius: 999px; border: 1px solid rgba(70,100,160,.38); background: rgba(10,14,22,.7); font-size: 12px; opacity: .96; }
    .pill b{ font-weight:900; }
    .row { display:grid; gap: 10px; }
    .row.inline { grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 760px) { .row.inline { grid-template-columns: 1fr; } }
    .grid { display:grid; grid-template-columns: 1.2fr .8fr; gap: 16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .tabbar { display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .tabbar button{
      padding: 10px 12px; border-radius: 999px; border: 1px solid rgba(70,100,160,.38);
      background: rgba(10,14,22,.55); color:#e8eef6; cursor:pointer; font-weight:900;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
    }
    .tabbar button:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.25); }
    .tabbar button.active { background: linear-gradient(135deg, #2b7fff, #7a5cff); border-color: transparent; color: white; }
    .tab { display:none; }
    .tab.active { display:block; }

    label { font-size: 13px; opacity: .98; display:flex; align-items:center; gap:8px; }
    .lockTag{ font-size:12px; opacity:.9; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.22); }
    textarea, input, select {
      width: 100%; box-sizing: border-box;
      padding: 10px 12px; border-radius: 14px;
      border: 1px solid rgba(70,100,160,.38); background: rgba(10,14,22,.62); color: #e8eef6;
      outline: none;
      transition: box-shadow .12s ease, transform .12s ease, border-color .12s ease;
    }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(120,170,255,.7);
      box-shadow: 0 0 0 4px rgba(43,127,255,.18);
    }
    textarea { min-height: 120px; resize: vertical; }

    button.primary {
      padding: 12px 14px; border-radius: 14px; border: 0;
      background: linear-gradient(135deg, #2b7fff, #7a5cff);
      color: white; font-weight: 950; cursor: pointer;
      box-shadow: 0 10px 26px rgba(43,127,255,.22);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    button.primary:hover{ transform: translateY(-1px); filter: brightness(1.06); box-shadow: 0 14px 30px rgba(43,127,255,.28); }
    button.secondary {
      padding: 12px 14px; border-radius: 14px; border: 1px solid rgba(70,100,160,.38);
      background: rgba(10,14,22,.55); color: #e8eef6; font-weight: 950; cursor: pointer;
      transition: transform .12s ease, background .12s ease;
    }
    button.secondary:hover{ transform: translateY(-1px); background: rgba(10,14,22,.68); }
    button:disabled { opacity: .55; cursor:not-allowed; transform:none !important; }

    canvas#wheelCanvas { width: 100%; height: auto; background: rgba(10,14,22,.55); border-radius: 18px; border: 1px solid rgba(70,100,160,.38); }

    .result {
      font-size: 18px; font-weight: 950; padding: 12px; border-radius: 14px;
      background: rgba(10,14,22,.62); border: 1px solid rgba(70,100,160,.38);
      position: relative;
      overflow: hidden;
    }
    .result.pop{ animation: pop .25s ease; }
    @keyframes pop{ 0%{ transform: scale(.98);} 60%{ transform: scale(1.03);} 100%{ transform: scale(1);} }

    .history { font-size: 13px; max-height: 160px; overflow:auto; }
    .history div { padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,.06); opacity:.95; }

    .roulette-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .roulette-cell {
      border: 1px solid rgba(70,100,160,.38); border-radius: 12px; padding: 10px;
      background: rgba(10,14,22,.55); display:flex; align-items:center; justify-content:space-between;
      font-weight:950;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .roulette-cell.active { outline: 2px solid rgba(43,127,255,.95); box-shadow: 0 0 0 6px rgba(43,127,255,.15); transform: translateY(-1px); }
    .roulette-cell.red { background: linear-gradient(180deg, rgba(255,80,80,0.18), rgba(10,14,22,.55)); }
    .roulette-cell.black { background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(10,14,22,.55)); }
    .roulette-cell.green { background: linear-gradient(180deg, rgba(70,255,170,0.16), rgba(10,14,22,.55)); }

    .hand { display:flex; flex-wrap:wrap; gap:8px; }
    .cardchip{
      border:1px solid rgba(70,100,160,.38); background: rgba(10,14,22,.62); border-radius:14px;
      padding:10px 12px; font-weight:950; min-width: 68px; text-align:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      animation: deal .18s ease;
    }
    @keyframes deal { from{ transform: translateY(6px); opacity:.0;} to{ transform: translateY(0); opacity:1;} }

    #fxCanvas{ position: fixed; inset: 0; pointer-events: none; z-index: 50; }
    .toastWrap{ position: fixed; right: 14px; bottom: 14px; display:grid; gap:10px; z-index: 60; }
    .toast{
      width: min(360px, calc(100vw - 28px));
      background: rgba(10,14,22,.78);
      border: 1px solid rgba(70,100,160,.38);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      animation: toastIn .18s ease;
    }
    @keyframes toastIn{ from{ transform: translateY(8px); opacity:.0;} to{ transform: translateY(0); opacity:1;} }
    .toast b{ font-weight:950; }
    .miniBtn{
      padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(70,100,160,.38);
      background: rgba(10,14,22,.55); color:#e8eef6; cursor:pointer; font-weight:900;
    }

    .shake{ animation: shake .22s ease; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-4px); }
      50%{ transform: translateX(4px); }
      75%{ transform: translateX(-3px); }
      100%{ transform: translateX(0); }
    }

    .toggle{ display:flex; align-items:center; gap:8px; }
    .toggle input{ width:auto; transform: translateY(1px); }
  </style>
</head>
<body>
  <canvas id="fxCanvas"></canvas>
  <div class="toastWrap" id="toastWrap"></div>

  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>üßß L√¨ X√¨ Arcade</h1>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span class="pill">Status: <b id="mpStatus">Offline</b></span>
          <span class="pill">Room: <b id="roomCode">demo</b></span>
          <span class="pill">B·∫°n: <b id="playerCode">‚Äî</b></span>
          <span class="pill">Online: <b id="presence">‚Äî</b></span>
          <button class="miniBtn" id="copyLinkBtn">Copy link ph√≤ng</button>
          <span class="pill toggle"><input type="checkbox" id="lockMode" checked /> Lock mode</span>
        </div>
      </div>

      <div class="tabbar" role="tablist" aria-label="Game tabs">
        <button class="active" data-tab-btn="wheel">V√≤ng quay</button>
        <button data-tab-btn="taixiu">T√†i/X·ªâu</button>
        <button data-tab-btn="blackjack">Blackjack</button>
        <button data-tab-btn="roulette">Roulette</button>
      </div>
    </div>

    <section class="card tab active" id="tab-wheel" data-tab="wheel">
      <h2>V√≤ng quay</h2>
      <div class="grid">
        <div class="row">
          <canvas id="wheelCanvas" width="720" height="720"></canvas>
        </div>
        <div class="row">
          <label>
            M·ª•c
            <span class="lockTag" id="lockTag-wheelItems" style="display:none"></span>
          </label>
          <textarea id="wheelItems"></textarea>

          <label>
            T·ªëc ƒë·ªô
            <span class="lockTag" id="lockTag-wheelSpeed" style="display:none"></span>
          </label>
          <input id="wheelSpeed" type="range" min="1" max="10" value="6" />

          <div class="row inline">
            <button class="primary" id="wheelSpinBtn">Quay</button>
            <button class="secondary" id="wheelResetBtn">Reset</button>
          </div>

          <div class="result" id="wheelResult">‚Äî</div>
          <div class="history" id="wheelHistory"></div>
        </div>
      </div>
    </section>

    <section class="card tab" id="tab-taixiu" data-tab="taixiu">
      <h2>T√†i/X·ªâu</h2>
      <div class="grid">
        <div class="row">
          <div class="row inline">
            <div>
              <label>T√¥i ch·ªçn</label>
              <select id="txPick">
                <option value="tai">T√†i</option>
                <option value="xiu">X·ªâu</option>
              </select>
            </div>
            <div>
              <label>T·ªëc ƒë·ªô hi·ªáu ·ª©ng</label>
              <input id="txSpeed" type="range" min="1" max="10" value="6" />
            </div>
          </div>

          <div class="row inline">
            <button class="primary" id="txRollBtn">L·∫Øc</button>
            <button class="secondary" id="txResetBtn">Reset</button>
          </div>

          <div class="result" id="txResult">‚Äî</div>
          <div class="history" id="txHistory"></div>
        </div>

        <div class="row">
          <div class="card" style="padding:14px;">
            <label>
              TH·∫ÆNG
              <span class="lockTag" id="lockTag-txWinRewards" style="display:none"></span>
            </label>
            <textarea id="txWinRewards"></textarea>

            <label>
              THUA
              <span class="lockTag" id="lockTag-txLoseRewards" style="display:none"></span>
            </label>
            <textarea id="txLoseRewards"></textarea>
          </div>
        </div>
      </div>
    </section>

    <section class="card tab" id="tab-blackjack" data-tab="blackjack">
      <h2>Blackjack</h2>
      <div class="grid">
        <div class="row">
          <div class="row inline">
            <button class="primary" id="bjDealBtn">Chia</button>
            <button class="secondary" id="bjNewBtn">V√°n m·ªõi</button>
          </div>

          <div class="row inline">
            <button class="primary" id="bjHitBtn" disabled>R√∫t</button>
            <button class="secondary" id="bjStandBtn" disabled>D·ª´ng</button>
          </div>

          <div class="card" style="padding:14px;">
            <div style="opacity:.86;font-size:13px;">Dealer</div>
            <div class="hand" id="bjDealerHand"></div>
            <div style="height:12px"></div>
            <div style="opacity:.86;font-size:13px;">B·∫°n</div>
            <div class="hand" id="bjPlayerHand"></div>
            <div style="height:12px"></div>
            <div class="result" id="bjResult">‚Äî</div>
          </div>

          <div class="history" id="bjHistory"></div>
        </div>

        <div class="row">
          <div class="card" style="padding:14px;">
            <label>
              TH·∫ÆNG
              <span class="lockTag" id="lockTag-bjWinRewards" style="display:none"></span>
            </label>
            <textarea id="bjWinRewards"></textarea>

            <label>
              H√íA
              <span class="lockTag" id="lockTag-bjPushRewards" style="display:none"></span>
            </label>
            <textarea id="bjPushRewards"></textarea>

            <label>
              THUA
              <span class="lockTag" id="lockTag-bjLoseRewards" style="display:none"></span>
            </label>
            <textarea id="bjLoseRewards"></textarea>
          </div>
        </div>
      </div>
    </section>

    <section class="card tab" id="tab-roulette" data-tab="roulette">
      <h2>Roulette</h2>
      <div class="grid">
        <div class="row">
          <div class="row inline">
            <div>
              <label>T√¥i c∆∞·ª£c</label>
              <select id="rlBetType">
                <option value="red">ƒê·ªè</option>
                <option value="black">ƒêen</option>
                <option value="odd">L·∫ª</option>
                <option value="even">Ch·∫µn</option>
                <option value="low">1‚Äì18</option>
                <option value="high">19‚Äì36</option>
                <option value="number">S·ªë</option>
              </select>
            </div>
            <div id="rlNumberWrap" style="display:none;">
              <label>S·ªë (0‚Äì36)</label>
              <input id="rlNumber" type="number" min="0" max="36" value="7" />
            </div>
          </div>

          <div class="row inline">
            <button class="primary" id="rlSpinBtn">Quay</button>
            <button class="secondary" id="rlResetBtn">Reset</button>
          </div>

          <div class="result" id="rlResult">‚Äî</div>
          <div class="roulette-grid" id="rlGrid"></div>
          <div class="history" id="rlHistory"></div>
        </div>

        <div class="row">
          <div class="card" style="padding:14px;">
            <label>
              TR√öNG
              <span class="lockTag" id="lockTag-rlWinRewards" style="display:none"></span>
            </label>
            <textarea id="rlWinRewards"></textarea>

            <label>
              TR·∫¨T
              <span class="lockTag" id="lockTag-rlLoseRewards" style="display:none"></span>
            </label>
            <textarea id="rlLoseRewards"></textarea>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    (() => {
      const fxCanvas = document.getElementById("fxCanvas");
      const fx = fxCanvas.getContext("2d");
      let fxW = 0, fxH = 0;
      function fxResize() {
        const dpr = window.devicePixelRatio || 1;
        fxW = Math.floor(innerWidth * dpr);
        fxH = Math.floor(innerHeight * dpr);
        fxCanvas.width = fxW;
        fxCanvas.height = fxH;
        fxCanvas.style.width = innerWidth + "px";
        fxCanvas.style.height = innerHeight + "px";
        fx.setTransform(1,0,0,1,0,0);
      }
      addEventListener("resize", fxResize);
      fxResize();

      const toastWrap = document.getElementById("toastWrap");
      function toast(title, msg) {
        const el = document.createElement("div");
        el.className = "toast";
        el.innerHTML = `<b>${title}</b><div style="opacity:.92;margin-top:4px">${msg}</div>`;
        toastWrap.appendChild(el);
        setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateY(6px)"; }, 2600);
        setTimeout(() => el.remove(), 3100);
      }

      let audioCtx = null;
      function beep(type) {
        try {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const t0 = audioCtx.currentTime;
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "sine";
          o.frequency.value = type === "win" ? 880 : type === "spin" ? 520 : 180;
          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(type === "win" ? 0.10 : 0.06, t0 + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + (type === "win" ? 0.24 : 0.16));
          o.connect(g); g.connect(audioCtx.destination);
          o.start(t0);
          o.stop(t0 + (type === "win" ? 0.26 : 0.18));
        } catch {}
      }

      const confetti = [];
      function confettiBurst(intensity=1) {
        const n = Math.floor(80 * intensity);
        for (let i = 0; i < n; i++) {
          confetti.push({
            x: fxW * (0.2 + Math.random() * 0.6),
            y: -20,
            vx: (Math.random() - 0.5) * 6,
            vy: 6 + Math.random() * 8,
            r: 2 + Math.random() * 4,
            a: 1,
            rot: Math.random() * Math.PI,
            vr: (Math.random() - 0.5) * 0.25
          });
        }
      }
      function fxTick() {
        fx.clearRect(0,0,fxW,fxH);
        for (let i = confetti.length - 1; i >= 0; i--) {
          const p = confetti[i];
          p.vy += 0.15;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.a *= 0.992;
          if (p.y > fxH + 60 || p.a < 0.03) confetti.splice(i, 1);
          else {
            fx.save();
            fx.globalAlpha = p.a;
            fx.translate(p.x, p.y);
            fx.rotate(p.rot);
            fx.fillStyle = `hsl(${Math.floor((p.x+p.y) % 360)}, 90%, 60%)`;
            fx.fillRect(-p.r, -p.r, p.r*2.2, p.r*1.2);
            fx.restore();
          }
        }
        requestAnimationFrame(fxTick);
      }
      fxTick();

      function nowTime() { return new Date().toLocaleTimeString(); }
      function addHistory(container, text) {
        const div = document.createElement("div");
        div.textContent = `${nowTime()} ‚Äî ${text}`;
        container.prepend(div);
      }
      function who(by) { return by ? `P${by}` : "Kh√°ch"; }

      const mpStatusEl = document.getElementById("mpStatus");
      const roomCodeEl = document.getElementById("roomCode");
      const playerCodeEl = document.getElementById("playerCode");
      const presenceEl = document.getElementById("presence");
      const copyLinkBtn = document.getElementById("copyLinkBtn");
      const lockModeEl = document.getElementById("lockMode");

      const qs = new URLSearchParams(location.search);
      const room = qs.get("room") || "demo";
      roomCodeEl.textContent = room;

      copyLinkBtn.addEventListener("click", async () => {
        const link = `${location.origin}/?room=${encodeURIComponent(room)}`;
        try {
          await navigator.clipboard.writeText(link);
          toast("Copied", link);
          beep("spin");
        } catch {
          toast("Copy failed", link);
        }
      });

      let socket = null;
      let myPlayerId = 0;
      let locks = {};

      function lockTag(field, pid) {
        const el = document.getElementById("lockTag-" + field);
        if (!el) return;
        if (!pid) { el.style.display = "none"; el.textContent = ""; return; }
        el.style.display = "inline-flex";
        el.textContent = `ƒëang ch·ªânh b·ªüi P${pid}`;
      }

      function applyLockState() {
        const lockMode = !!lockModeEl.checked;
        const map = locks || {};
        const lockFields = Object.keys(map);

        const isLockedByOther = (field) => lockMode && map[field] && map[field] !== myPlayerId;

        const setRO = (el, ro) => {
          if (!el) return;
          if (el.tagName === "TEXTAREA" || el.tagName === "INPUT") el.readOnly = ro;
          if (el.tagName === "SELECT") el.disabled = ro;
        };

        const items = [
          ["wheelItems", document.getElementById("wheelItems")],
          ["wheelSpeed", document.getElementById("wheelSpeed")],
          ["txWinRewards", document.getElementById("txWinRewards")],
          ["txLoseRewards", document.getElementById("txLoseRewards")],
          ["bjWinRewards", document.getElementById("bjWinRewards")],
          ["bjPushRewards", document.getElementById("bjPushRewards")],
          ["bjLoseRewards", document.getElementById("bjLoseRewards")],
          ["rlWinRewards", document.getElementById("rlWinRewards")],
          ["rlLoseRewards", document.getElementById("rlLoseRewards")]
        ];

        for (const [f, el] of items) setRO(el, isLockedByOther(f));
        for (const f of ["wheelItems","wheelSpeed","txWinRewards","txLoseRewards","bjWinRewards","bjPushRewards","bjLoseRewards","rlWinRewards","rlLoseRewards"]) {
          lockTag(f, map[f] || 0);
        }
      }

      function setLock(field, locked) {
        if (!socket || !socket.connected) return;
        socket.emit("lock:set", { field, locked });
      }

      function bindLock(el, field) {
        el.addEventListener("focus", () => { if (lockModeEl.checked) setLock(field, true); });
        el.addEventListener("blur",  () => { if (lockModeEl.checked) setLock(field, false); });
      }

      function sendState(field, value) {
        if (!socket || !socket.connected) return;
        socket.emit("state:set", { field, value });
      }

      function debounce(fn, ms) {
        let t = null;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      let applying = new Set();
      function applyControlValue(el, value, key) {
        if (!el) return;
        applying.add(key);
        if (el.type === "range" || el.type === "number") el.value = String(value);
        else el.value = String(value ?? "");
        applying.delete(key);
      }

      const tabBtns = [...document.querySelectorAll("[data-tab-btn]")];
      const tabs = [...document.querySelectorAll(".tab")];

      function setTab(name, silent=false) {
        tabBtns.forEach(b => b.classList.toggle("active", b.getAttribute("data-tab-btn") === name));
        tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === name));
        if (!silent && socket && socket.connected) socket.emit("ui:tab", { tab: name });
      }

      tabBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          beep("spin");
          const name = btn.getAttribute("data-tab-btn");
          setTab(name, false);
        });
      });

      const wheelCanvas = document.getElementById("wheelCanvas");
      const wctx = wheelCanvas.getContext("2d");
      const wheelItemsEl = document.getElementById("wheelItems");
      const wheelSpinBtn = document.getElementById("wheelSpinBtn");
      const wheelResetBtn = document.getElementById("wheelResetBtn");
      const wheelResultEl = document.getElementById("wheelResult");
      const wheelHistoryEl = document.getElementById("wheelHistory");
      const wheelSpeedEl = document.getElementById("wheelSpeed");

      let wheelItems = [];
      let wheelAngle = 0;
      let wheelSpinning = false;

      function parseLines(text) {
        return String(text || "").split("\n").map(s => s.trim()).filter(Boolean);
      }

      function wheelParseItems() {
        wheelItems = parseLines(wheelItemsEl.value);
        if (wheelItems.length < 2) wheelItems = ["10,000‚Ç´", "20,000‚Ç´"];
      }

      function wheelDraw() {
        const W = wheelCanvas.width, H = wheelCanvas.height;
        const cx = W / 2, cy = H / 2;
        const r = Math.min(W, H) * 0.45;

        wctx.clearRect(0, 0, W, H);

        const glow = wctx.createRadialGradient(cx, cy, r*0.2, cx, cy, r*1.1);
        glow.addColorStop(0, "rgba(122,92,255,0.18)");
        glow.addColorStop(1, "rgba(0,0,0,0)");
        wctx.fillStyle = glow;
        wctx.beginPath();
        wctx.arc(cx, cy, r*1.02, 0, Math.PI*2);
        wctx.fill();

        const n = wheelItems.length;
        const slice = (Math.PI * 2) / n;

        for (let i = 0; i < n; i++) {
          const a0 = wheelAngle + i * slice;
          const a1 = a0 + slice;

          wctx.beginPath();
          wctx.moveTo(cx, cy);
          wctx.arc(cx, cy, r, a0, a1);
          wctx.closePath();

          wctx.fillStyle = (i % 2 === 0) ? "rgba(255,255,255,0.10)" : "rgba(255,255,255,0.18)";
          wctx.fill();

          wctx.strokeStyle = "rgba(255,255,255,0.10)";
          wctx.lineWidth = 2;
          wctx.stroke();

          wctx.save();
          wctx.translate(cx, cy);
          wctx.rotate(a0 + slice / 2);
          wctx.textAlign = "right";
          wctx.fillStyle = "rgba(232,238,246,0.95)";
          wctx.font = "900 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          const label = wheelItems[i];
          wctx.fillText(label.length > 18 ? label.slice(0, 18) + "‚Ä¶" : label, r - 16, 8);
          wctx.restore();
        }

        wctx.beginPath();
        wctx.arc(cx, cy, r * 0.14, 0, Math.PI * 2);
        wctx.fillStyle = "rgba(8,10,16,.92)";
        wctx.fill();
        wctx.strokeStyle = "rgba(255,255,255,0.12)";
        wctx.lineWidth = 2;
        wctx.stroke();

        wctx.beginPath();
        wctx.moveTo(cx, cy - r - 22);
        wctx.lineTo(cx - 18, cy - r + 14);
        wctx.lineTo(cx + 18, cy - r + 14);
        wctx.closePath();
        wctx.fillStyle = "#2b7fff";
        wctx.fill();
      }

      function wheelIndexAtPointer() {
        const n = wheelItems.length;
        const slice = (Math.PI * 2) / n;

        let a = wheelAngle % (Math.PI * 2);
        if (a < 0) a += Math.PI * 2;

        const pointer = (Math.PI * 1.5);
        let rel = pointer - a;
        rel = rel % (Math.PI * 2);
        if (rel < 0) rel += Math.PI * 2;

        return Math.floor(rel / slice) % n;
      }

      function wheelSpinTo(targetIndex) {
        if (wheelSpinning) return;
        wheelParseItems();

        wheelSpinning = true;
        wheelSpinBtn.disabled = true;

        const current = wheelIndexAtPointer();
        const n = wheelItems.length;
        const slice = (Math.PI * 2) / n;

        let delta = (targetIndex - current);
        if (delta < 0) delta += n;

        const sp = Number(wheelSpeedEl.value || 6);
        const baseTurns = 7 + Math.floor(sp / 2);
        const totalRotation = (baseTurns * Math.PI * 2) + (delta * slice);

        const startAngle = wheelAngle;
        const duration = 1900 + sp * 190;
        const t0 = performance.now();
        const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

        wheelResultEl.textContent = "‚Ä¶";
        wheelResultEl.classList.remove("pop");

        beep("spin");

        function frame(t) {
          const p = Math.min(1, (t - t0) / duration);
          wheelAngle = startAngle + totalRotation * easeOutCubic(p);
          wheelDraw();

          if (p < 1) requestAnimationFrame(frame);
          else {
            wheelSpinning = false;
            wheelSpinBtn.disabled = false;

            const idx = wheelIndexAtPointer();
            const win = wheelItems[idx] || "‚Äî";
            wheelResultEl.textContent = win;
            wheelResultEl.classList.add("pop");

            const big = /1,000,000|500,000|Nh√¢n ƒë√¥i|üéâ/i.test(win);
            if (big) { confettiBurst(1.2); beep("win"); }
          }
        }
        requestAnimationFrame(frame);
      }

      function wheelReset() {
        wheelSpinning = false;
        wheelSpinBtn.disabled = false;
        wheelResultEl.textContent = "‚Äî";
        wheelHistoryEl.innerHTML = "";
        wheelAngle = 0;
        wheelParseItems();
        wheelDraw();
      }

      wheelResetBtn.addEventListener("click", () => { beep("tap"); wheelReset(); });

      bindLock(wheelItemsEl, "wheelItems");
      bindLock(wheelSpeedEl, "wheelSpeed");

      wheelItemsEl.addEventListener("input", debounce(() => {
        if (applying.has("wheelItems")) return;
        sendState("wheelItems", wheelItemsEl.value);
        wheelParseItems();
        wheelDraw();
      }, 140));

      wheelSpeedEl.addEventListener("input", () => {
        if (applying.has("wheelSpeed")) return;
        sendState("wheelSpeed", Number(wheelSpeedEl.value));
      });

      wheelSpinBtn.addEventListener("click", () => {
        beep("spin");
        if (socket && socket.connected) socket.emit("wheel:spin");
      });

      wheelParseItems();
      wheelDraw();

      const txPickEl = document.getElementById("txPick");
      const txSpeedEl = document.getElementById("txSpeed");
      const txRollBtn = document.getElementById("txRollBtn");
      const txResetBtn = document.getElementById("txResetBtn");
      const txResultEl = document.getElementById("txResult");
      const txHistoryEl = document.getElementById("txHistory");
      const txWinRewardsEl = document.getElementById("txWinRewards");
      const txLoseRewardsEl = document.getElementById("txLoseRewards");

      const diceFaces = ["‚öÄ","‚öÅ","‚öÇ","‚öÉ","‚öÑ","‚öÖ"];

      bindLock(txWinRewardsEl, "txWinRewards");
      bindLock(txLoseRewardsEl, "txLoseRewards");

      txWinRewardsEl.addEventListener("input", debounce(() => {
        if (applying.has("txWinRewards")) return;
        sendState("txWinRewards", txWinRewardsEl.value);
      }, 140));

      txLoseRewardsEl.addEventListener("input", debounce(() => {
        if (applying.has("txLoseRewards")) return;
        sendState("txLoseRewards", txLoseRewardsEl.value);
      }, 140));

      txPickEl.addEventListener("change", () => {
        beep("tap");
        if (!myPlayerId) return;
        sendState(`txPick.${myPlayerId}`, txPickEl.value);
        toast("T√†i/X·ªâu", `B·∫°n ch·ªçn ${txPickEl.value === "tai" ? "T√ÄI" : "X·ªàU"}`);
      });

      txRollBtn.addEventListener("click", () => {
        beep("spin");
        if (socket && socket.connected) socket.emit("tx:roll");
      });

      txResetBtn.addEventListener("click", () => {
        beep("tap");
        txResultEl.textContent = "‚Äî";
        txHistoryEl.innerHTML = "";
        txRollBtn.disabled = false;
      });

      function animateDiceThen(final, speed) {
        const steps = 7 + Number(speed || 6);
        let i = 0;
        txRollBtn.disabled = true;
        function r() { return 1 + Math.floor(Math.random() * 6); }
        function tick() {
          i++;
          const d1 = r(), d2 = r(), d3 = r();
          const sum = d1 + d2 + d3;
          txResultEl.textContent = `${diceFaces[d1-1]} ${diceFaces[d2-1]} ${diceFaces[d3-1]} | ${sum}`;
          if (i < steps) {
            setTimeout(tick, 38 + (10 - Number(speed || 6)) * 10);
          } else {
            txRollBtn.disabled = false;
            final();
          }
        }
        tick();
      }

      const bjDealBtn = document.getElementById("bjDealBtn");
      const bjNewBtn = document.getElementById("bjNewBtn");
      const bjHitBtn = document.getElementById("bjHitBtn");
      const bjStandBtn = document.getElementById("bjStandBtn");

      const bjDealerHandEl = document.getElementById("bjDealerHand");
      const bjPlayerHandEl = document.getElementById("bjPlayerHand");
      const bjResultEl = document.getElementById("bjResult");
      const bjHistoryEl = document.getElementById("bjHistory");

      const bjWinRewardsEl = document.getElementById("bjWinRewards");
      const bjPushRewardsEl = document.getElementById("bjPushRewards");
      const bjLoseRewardsEl = document.getElementById("bjLoseRewards");

      bindLock(bjWinRewardsEl, "bjWinRewards");
      bindLock(bjPushRewardsEl, "bjPushRewards");
      bindLock(bjLoseRewardsEl, "bjLoseRewards");

      bjWinRewardsEl.addEventListener("input", debounce(() => {
        if (applying.has("bjWinRewards")) return;
        sendState("bjWinRewards", bjWinRewardsEl.value);
      }, 140));
      bjPushRewardsEl.addEventListener("input", debounce(() => {
        if (applying.has("bjPushRewards")) return;
        sendState("bjPushRewards", bjPushRewardsEl.value);
      }, 140));
      bjLoseRewardsEl.addEventListener("input", debounce(() => {
        if (applying.has("bjLoseRewards")) return;
        sendState("bjLoseRewards", bjLoseRewardsEl.value);
      }, 140));

      let bjPlayer = [];
      let bjDealer = [];
      let bjInRound = false;
      let bjDealerHidden = true;
      let bjTurn = 1;

      function bjCardText(c) { return `${c.r}${c.s}`; }
      function bjHandValue(hand) {
        let total = 0;
        let aces = 0;
        for (const c of hand) {
          if (c.r === "A") { aces++; total += 11; }
          else if (c.r === "K" || c.r === "Q" || c.r === "J") total += 10;
          else total += Number(c.r);
        }
        while (total > 21 && aces > 0) { total -= 10; aces--; }
        return total;
      }

      function bjRender() {
        bjDealerHandEl.innerHTML = "";
        bjPlayerHandEl.innerHTML = "";

        bjDealer.forEach((c, idx) => {
          const chip = document.createElement("div");
          chip.className = "cardchip";
          chip.textContent = (bjDealerHidden && idx === 1 && bjInRound) ? "‚ùì" : bjCardText(c);
          bjDealerHandEl.appendChild(chip);
        });

        bjPlayer.forEach(c => {
          const chip = document.createElement("div");
          chip.className = "cardchip";
          chip.textContent = bjCardText(c);
          bjPlayerHandEl.appendChild(chip);
        });
      }

      function applyBjState(s, silent) {
        bjPlayer = s.player || [];
        bjDealer = s.dealer || [];
        bjInRound = !!s.inRound;
        bjDealerHidden = !!s.dealerHidden;
        bjTurn = s.turn || 1;

        const isMyTurn = myPlayerId && bjTurn === myPlayerId;

        bjDealBtn.disabled = bjInRound || !isMyTurn;
        bjHitBtn.disabled = !bjInRound || !isMyTurn;
        bjStandBtn.disabled = !bjInRound || !isMyTurn;

        bjRender();

        const pVal = bjHandValue(bjPlayer);
        const dVal = bjHandValue(bjDealer);

        if (!bjInRound && s.lastOutcome) {
          const label = s.lastOutcome === "win" ? "TH·∫ÆNG" : s.lastOutcome === "push" ? "H√íA" : "THUA";
          bjResultEl.textContent = `${label} | B·∫°n ${pVal} | Dealer ${dVal} | ${s.lastReward || "‚Äî"} | L∆∞·ª£t: P${bjTurn}`;
          bjResultEl.classList.add("pop");

          if (!silent) addHistory(bjHistoryEl, `${label}: ${pVal}-${dVal} | ${s.lastReward || "‚Äî"}`);

          if (s.lastOutcome === "win") { confettiBurst(1.1); beep("win"); }
          else if (s.lastOutcome === "lose") { document.body.classList.add("shake"); beep("tap"); setTimeout(()=>document.body.classList.remove("shake"), 240); }
        } else {
          bjResultEl.textContent = bjInRound && bjDealerHidden ? `B·∫°n ${pVal} | Dealer ? | L∆∞·ª£t: P${bjTurn}` : `B·∫°n ${pVal} | Dealer ${dVal} | L∆∞·ª£t: P${bjTurn}`;
        }
      }

      bjDealBtn.addEventListener("click", () => { beep("spin"); if (socket && socket.connected) socket.emit("bj:deal"); });
      bjHitBtn.addEventListener("click", () => { beep("tap"); if (socket && socket.connected) socket.emit("bj:hit"); });
      bjStandBtn.addEventListener("click", () => { beep("tap"); if (socket && socket.connected) socket.emit("bj:stand"); });
      bjNewBtn.addEventListener("click", () => { beep("tap"); if (socket && socket.connected) socket.emit("bj:new"); });

      const rlBetTypeEl = document.getElementById("rlBetType");
      const rlNumberWrap = document.getElementById("rlNumberWrap");
      const rlNumberEl = document.getElementById("rlNumber");
      const rlSpinBtn = document.getElementById("rlSpinBtn");
      const rlResetBtn = document.getElementById("rlResetBtn");
      const rlResultEl = document.getElementById("rlResult");
      const rlGridEl = document.getElementById("rlGrid");
      const rlHistoryEl = document.getElementById("rlHistory");
      const rlWinRewardsEl = document.getElementById("rlWinRewards");
      const rlLoseRewardsEl = document.getElementById("rlLoseRewards");

      bindLock(rlWinRewardsEl, "rlWinRewards");
      bindLock(rlLoseRewardsEl, "rlLoseRewards");

      rlWinRewardsEl.addEventListener("input", debounce(() => {
        if (applying.has("rlWinRewards")) return;
        sendState("rlWinRewards", rlWinRewardsEl.value);
      }, 140));
      rlLoseRewardsEl.addEventListener("input", debounce(() => {
        if (applying.has("rlLoseRewards")) return;
        sendState("rlLoseRewards", rlLoseRewardsEl.value);
      }, 140));

      const redNums = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
      function rlColor(n) { if (n === 0) return "green"; return redNums.has(n) ? "red" : "black"; }

      function rlBuildGrid() {
        rlGridEl.innerHTML = "";
        for (let n = 0; n <= 36; n++) {
          const cell = document.createElement("div");
          cell.className = `roulette-cell ${rlColor(n)}`;
          cell.setAttribute("data-num", String(n));
          cell.innerHTML = `<span>${n}</span><span style="opacity:.8;font-size:12px">${rlColor(n).toUpperCase()}</span>`;
          rlGridEl.appendChild(cell);
        }
      }
      function rlHighlight(n) {
        [...rlGridEl.querySelectorAll(".roulette-cell")].forEach(c => c.classList.remove("active"));
        const hit = rlGridEl.querySelector(`.roulette-cell[data-num="${n}"]`);
        if (hit) hit.classList.add("active");
      }
      rlBuildGrid();

      function updateRlNumberWrap() {
        rlNumberWrap.style.display = (rlBetTypeEl.value === "number") ? "block" : "none";
      }
      rlBetTypeEl.addEventListener("change", () => {
        beep("tap");
        updateRlNumberWrap();
        if (!myPlayerId) return;
        sendState(`rlBet.${myPlayerId}.betType`, rlBetTypeEl.value);
      });
      rlNumberEl.addEventListener("input", debounce(() => {
        if (!myPlayerId) return;
        sendState(`rlBet.${myPlayerId}.betNumber`, Number(rlNumberEl.value || 0));
      }, 120));

      rlSpinBtn.addEventListener("click", () => { beep("spin"); if (socket && socket.connected) socket.emit("rl:spin"); });
      rlResetBtn.addEventListener("click", () => {
        beep("tap");
        rlResultEl.textContent = "‚Äî";
        rlHistoryEl.innerHTML = "";
        rlHighlight(-1);
      });

      function animateRouletteThen(final) {
        rlSpinBtn.disabled = true;
        let k = 0;
        const steps = 20;
        const timer = setInterval(() => {
          k++;
          rlHighlight(Math.floor(Math.random() * 37));
          if (k >= steps) {
            clearInterval(timer);
            rlSpinBtn.disabled = false;
            final();
          }
        }, 45);
      }

      function setResult(el, text) {
        el.textContent = text;
        el.classList.remove("pop");
        void el.offsetWidth;
        el.classList.add("pop");
      }

      lockModeEl.addEventListener("change", () => {
        applyLockState();
        toast("Lock mode", lockModeEl.checked ? "B·∫≠t (tr√°nh ƒë√® nhau)" : "T·∫Øt (ai c≈©ng s·ª≠a ƒë∆∞·ª£c)");
      });

      try {
        socket = io({ query: { room }, transports: ["websocket"] });
        socket.on("connect", () => { mpStatusEl.textContent = "Online"; toast("K·∫øt n·ªëi", "ƒê√£ v√†o ph√≤ng"); });
        socket.on("disconnect", () => { mpStatusEl.textContent = "Offline"; toast("M·∫•t k·∫øt n·ªëi", "Render c√≥ th·ªÉ ƒëang sleep, th·ª≠ t·∫£i l·∫°i"); });

        socket.on("init", data => {
          myPlayerId = data.playerId || 0;
          playerCodeEl.textContent = myPlayerId ? `P${myPlayerId}` : "Kh√°ch";

          if (data.state) {
            const s = data.state;

            applyControlValue(wheelItemsEl, s.wheelItems, "wheelItems");
            applyControlValue(wheelSpeedEl, s.wheelSpeed, "wheelSpeed");
            wheelParseItems(); wheelDraw();

            applyControlValue(txWinRewardsEl, s.txWinRewards, "txWinRewards");
            applyControlValue(txLoseRewardsEl, s.txLoseRewards, "txLoseRewards");

            applyControlValue(bjWinRewardsEl, s.bjWinRewards, "bjWinRewards");
            applyControlValue(bjPushRewardsEl, s.bjPushRewards, "bjPushRewards");
            applyControlValue(bjLoseRewardsEl, s.bjLoseRewards, "bjLoseRewards");

            applyControlValue(rlWinRewardsEl, s.rlWinRewards, "rlWinRewards");
            applyControlValue(rlLoseRewardsEl, s.rlLoseRewards, "rlLoseRewards");

            const tab = s.tab || "wheel";
            setTab(tab, true);

            if (myPlayerId) {
              const pick = (s.txPick && s.txPick[myPlayerId]) ? s.txPick[myPlayerId] : "tai";
              txPickEl.value = pick;

              const rb = (s.rlBet && s.rlBet[myPlayerId]) ? s.rlBet[myPlayerId] : { betType: "red", betNumber: 7 };
              rlBetTypeEl.value = rb.betType || "red";
              rlNumberEl.value = String(rb.betNumber ?? 7);
              updateRlNumberWrap();
            }
          }

          if (data.bj) applyBjState(data.bj, true);

          locks = data.locks || {};
          applyLockState();

          if (lockModeEl.checked) {
            bindLock(wheelItemsEl, "wheelItems");
            bindLock(wheelSpeedEl, "wheelSpeed");
            bindLock(txWinRewardsEl, "txWinRewards");
            bindLock(txLoseRewardsEl, "txLoseRewards");
            bindLock(bjWinRewardsEl, "bjWinRewards");
            bindLock(bjPushRewardsEl, "bjPushRewards");
            bindLock(bjLoseRewardsEl, "bjLoseRewards");
            bindLock(rlWinRewardsEl, "rlWinRewards");
            bindLock(rlLoseRewardsEl, "rlLoseRewards");
          }
        });

        socket.on("presence", data => {
          const ps = (data.players || []).map(p => `P${p}`).join(", ");
          presenceEl.textContent = ps || "‚Äî";
        });

        socket.on("lock:state", data => {
          locks = data.locks || {};
          applyLockState();
        });

        socket.on("state:set", d => {
          const f = d.field;
          const v = d.value;

          if (f === "tab") setTab(v, true);
          if (f === "wheelItems") { applyControlValue(wheelItemsEl, v, "wheelItems"); wheelParseItems(); wheelDraw(); }
          if (f === "wheelSpeed") { applyControlValue(wheelSpeedEl, v, "wheelSpeed"); }

          if (f === "txWinRewards") applyControlValue(txWinRewardsEl, v, "txWinRewards");
          if (f === "txLoseRewards") applyControlValue(txLoseRewardsEl, v, "txLoseRewards");

          if (f === "bjWinRewards") applyControlValue(bjWinRewardsEl, v, "bjWinRewards");
          if (f === "bjPushRewards") applyControlValue(bjPushRewardsEl, v, "bjPushRewards");
          if (f === "bjLoseRewards") applyControlValue(bjLoseRewardsEl, v, "bjLoseRewards");

          if (f === "rlWinRewards") applyControlValue(rlWinRewardsEl, v, "rlWinRewards");
          if (f === "rlLoseRewards") applyControlValue(rlLoseRewardsEl, v, "rlLoseRewards");

          if (myPlayerId && f === `txPick.${myPlayerId}`) txPickEl.value = v;

          if (myPlayerId && f === `rlBet.${myPlayerId}.betType`) { rlBetTypeEl.value = v; updateRlNumberWrap(); }
          if (myPlayerId && f === `rlBet.${myPlayerId}.betNumber`) rlNumberEl.value = String(v);
        });

        socket.on("ui:tab", d => {
          toast("Tab", `${who(d.by)} m·ªü ${d.tab}`);
        });

        socket.on("wheel:spinResult", data => {
          applyControlValue(wheelItemsEl, (data.items || []).join("\n"), "wheelItems");
          applyControlValue(wheelSpeedEl, data.speed || 6, "wheelSpeed");
          wheelParseItems(); wheelDraw();

          const idx = data.targetIndex;
          const v = (wheelItems[idx] || "‚Äî");
          addHistory(wheelHistoryEl, `${who(data.by)} quay: ${v}`);
          setResult(wheelResultEl, "‚Ä¶");
          wheelSpinTo(idx);
        });

        socket.on("tx:result", data => {
          const outLabel = (data.out === "tai") ? "T√ÄI" : "X·ªàU";
          const pickLabel = (data.pick === "tai") ? "T√ÄI" : "X·ªàU";
          const line = `${diceFaces[data.d1-1]} ${diceFaces[data.d2-1]} ${diceFaces[data.d3-1]} | ${data.sum} | ${outLabel} | ${pickLabel} | ${data.win ? "TH·∫ÆNG" : "THUA"} | ${data.reward}`;
          animateDiceThen(() => {
            setResult(txResultEl, line);
            addHistory(txHistoryEl, `${who(data.by)}: ${data.sum} ${outLabel} ${data.win ? "W" : "L"} ${data.reward}`);
            if (data.win) { confettiBurst(0.9); beep("win"); }
            else { beep("tap"); }
          }, txSpeedEl.value);
        });

        socket.on("rl:result", data => {
          animateRouletteThen(() => {
            rlHighlight(data.rolled);
            const betLabelMap = {
              red: "ƒê·ªé",
              black: "ƒêEN",
              odd: "L·∫∫",
              even: "CH·∫¥N",
              low: "1‚Äì18",
              high: "19‚Äì36",
              number: `S·ªê ${data.betNumber}`
            };
            const betLabel = betLabelMap[data.betType] || data.betType;

            const text = `Ra ${data.rolled} ${String(data.color).toUpperCase()} | ${betLabel} | ${data.win ? "TR√öNG" : "TR·∫¨T"} | ${data.reward}`;
            setResult(rlResultEl, text);
            addHistory(rlHistoryEl, `${who(data.by)}: ${data.rolled} ${data.win ? "W" : "L"} ${data.reward}`);
            if (data.win) { confettiBurst(1.0); beep("win"); }
            else { beep("tap"); }
          });
        });

        socket.on("bj:state", s => {
          applyBjState(s, false);
        });

      } catch {
        mpStatusEl.textContent = "Offline";
      }
    })();
  </script>
</body>
</html>
